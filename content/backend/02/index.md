---
title: "資料庫設計入門"
draft: false
slug: "class-02"
series: ["後端實務"]
series_order: 2
date: "2297-07-07"
---
本節課介紹資料庫概念設計、實作以及處理資料庫遷移。

## 資料庫模式設計
資料庫模式的設計是建立有效且有組織的資料庫結構的關鍵步驟。這一階段涉及到定義表結構，並確保這些表適當地表示資料間的關係。
開始設計時，首先定義表和關聯。例如，創建一個「traders」表來儲存帳戶信息，包括帳戶ID、所有者、餘額等信息。為了確保資料完整性和準確性，可以設定主鍵、外鍵以及其他約束條件，如非空（NOT NULL）和唯一（UNIQUE）等。

## 資料類型和約束條件的選擇
選擇合適的資料類型對於確保資料準確性和效率至關重要。例如，對於帳戶ID，選擇自增型別如 PostgreSQL 中的 `bigserial`；對於帳戶餘額，考慮使用 `bigint` 或在處理非整數貨幣時使用 `decimal`。此外，包括時間戳記時，使用 `timestamptz` 可包含時區信息，更為準確。

## 資料表的關聯性
在資料庫中，不同表之間的關聯性是通過外鍵來實現的。例如，在「records」表中，用外鍵 `trader_id` 來參照「traders」表，表明一個帳戶可以有多個條目。同樣地，「details」表記錄帳戶間的轉賬，也需要適當地設定外鍵以表示這種關聯。

## 索引的添加和優化
為了提升查詢效率，為常用的查詢欄位添加索引是必要的。例如，在「traders」表中，可能需要按所有者名稱查詢，因此將「holder」欄位加入索引；在「records」表中，則可能需要按帳戶ID查詢所有條目，因此將「trader_id」加入索引。

## 安裝 Go Migrate
首先，在 Mac 上使用 Homebrew 安裝 Go Migrate。
這個庫支持多種資料庫引擎，如 PostgreSQL、MySQL、MongoDB 和 CockroachDB。
完成安裝後，可通過 `migrate -version` 檢查版本，並使用 `migrate -help` 查閱手冊。

## 創建遷移文件
使用 `migrate create` 命令創建新的遷移文件。這將生成兩個文件，一個用於「升版」（up）遷移，另一個用於「降版」（down）遷移。將先前講座中生成的 SQL 內容複製到升版遷移文件中，在降版遷移文件中撰寫用於撤銷升版遷移更改的 SQL 腳本。

## Docker 命令和資料庫操作
介紹了使用 Docker 命令來管理 PostgreSQL 容器，包括啟動、停止、刪除容器，以及創建和刪除資料庫。

## 使用 Makefile 簡化流程
創建 Makefile 以簡化資料庫和容器的管理過程，包括創建和刪除資料庫、啟動和停止容器等。

## 執行資料庫遷移
使用 `migrate` 命令連接到資料庫並運行遷移腳本。升版遷移將應用所有未執行的遷移，而降版遷移則撤銷它們。

## 課程檔案記錄
{{< ghdiff "c53f4543b2dcbfc5c476df2e6a2b53f016a54228" >}}